name: ðŸš€ Auto-Generate Declaration PR
on:
  issues:
    types: [labeled]

jobs:
  create_migration_pr:
    if: github.event.label.name == 'migration-request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Code via Copilot Agent
        id: copilot_agent
        uses: github/copilot-action@v1 # Ensure this matches your specific agent tool
        with:
          prompt: |
            You are a software developer specialized in C# and .NET. 
            An issue has been raised to modify the Declaration Table in the cdm-referencedata-service.

            INSTRUCTIONS:
            1. Parse the issue body which contains three tables: ADD, UPDATE (Find/New), and DELETE.
            2. For ADD: Insert new records into the static declaration collection.
            3. For UPDATE: Use the 'Find' table (Country, Procedure, MessageName, Category) to locate the unique record and apply values from the 'New' table.
            4. For DELETE: Remove records matching the identifiers.
            5. Ensure all changes follow the existing schema and naming conventions.

            Issue Content:
            ${{ github.event.issue.body }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: automated declaration update from Issue #${{ github.event.issue.number }}"
          title: "Declaration Update: ${{ github.event.issue.title }}"
          body: |
            Automated PR generated by Copilot Agent.
            Triggered by Issue: #${{ github.event.issue.number }}
            Requested by: @${{ github.event.issue.user.login }}
          branch: "migration/issue-${{ github.event.issue.number }}"
          base: main

      - name: Comment on Issue
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ðŸš€ PR has been created successfully! Please review here: ${{ steps.copilot_agent.outputs.pull_request_url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
